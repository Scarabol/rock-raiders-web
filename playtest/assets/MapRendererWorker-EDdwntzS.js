(function(){"use strict";class _{constructor(t){this.worker=t,t.addEventListener("message",e=>this.onMessageFromFrontend(e?.data))}onMessageFromFrontend=()=>{throw new Error("Not implemented")};sendResponse(t,e){this.worker.postMessage(t,e)}}const L=1,M=Math.round(1e3/15),l=40;function h(c,t){if(!c)throw new Error("No canvas given");const e=c.getContext("2d",t);if(!e)throw new Error("Could not get context");return e}/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const S="180";function o(c,t,e){return Math.max(t,Math.min(e,c))}class f{constructor(t=0,e=0){f.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,r=this.y,i=t.elements;return this.x=i[0]*e+i[3]*r+i[6],this.y=i[1]*e+i[4]*r+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=o(this.x,t.x,e.x),this.y=o(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=o(this.x,t,e),this.y=o(this.y,t,e),this}clampLength(t,e){const r=this.length();return this.divideScalar(r||1).multiplyScalar(o(r,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const r=this.dot(t)/e;return Math.acos(o(r,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,r=this.y-t.y;return e*e+r*r}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const r=Math.cos(e),i=Math.sin(e),s=this.x-t.x,a=this.y-t.y;return this.x=s*r-a*i+t.x,this.y=s*i+a*r+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:S}})),typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=S);const y={default:1,monster:2,material:3,scanner:4};class A{constructor(t){this.worker=t,this.worker.onMessageFromFrontend=e=>this.processMessage(e)}surfaceContext=null;entityContext=null;monsterContext=null;materialContext=null;geoScanContext=null;cameraContext=null;blocked=new Set;markedDirty=new Map;processMessage(t){if(t.type===2)this.surfaceContext=h(t.terrainSprite),this.monsterContext=h(t.monsterSprite),this.materialContext=h(t.materialSprite),this.geoScanContext=h(t.geoScanSprite),this.entityContext=h(t.entitySprite),this.cameraContext=h(t.cameraSprite);else{switch(t.type){case 3:this.redrawTerrain(t.offset,t.surfaceRectSize,t.terrain);break;case 4:this.redrawSurface(t.offset,t.surfaceRectSize,t.surface);break;case 5:switch(t.mapMarkerType){case y.default:this.redrawEntitiesContext(t,this.entityContext,"#e8d400",4);break;case y.monster:this.redrawEntitiesContext(t,this.monsterContext,"#f00",3);break;case y.material:this.redrawEntitiesContext(t,this.materialContext,"#0f0",2);break;case y.scanner:this.redrawGeoScanContext(t);break}break;case 6:this.redrawCamera(t.offset,t.surfaceRectSize,t.rect);break}this.worker.sendResponse({type:1,requestId:t.requestId})}}redrawEntitiesContext(t,e,r,i){if(!e)return;if(this.blocked.has(t.mapMarkerType)){this.markedDirty.set(t.mapMarkerType,t);return}this.blocked.add(t.mapMarkerType),setTimeout(()=>{this.blocked.delete(t.mapMarkerType);const a=this.markedDirty.get(t.mapMarkerType);this.markedDirty.delete(t.mapMarkerType),a&&this.redrawEntitiesContext(a,e,r,i)},M),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=r;const s=Math.max(1,Math.round(i/15*t.surfaceRectSize));t.entities.forEach(a=>{const n=Math.round(a.x*t.surfaceRectSize/l-t.offset.x-s/2),u=Math.round(a.z*t.surfaceRectSize/l-t.offset.y-s/2);e.fillRect(n,u,s,s)})}redrawGeoScanContext(t){const e=this.geoScanContext;if(e){if(this.blocked.has(t.mapMarkerType)){this.markedDirty.set(t.mapMarkerType,t);return}this.blocked.add(t.mapMarkerType),setTimeout(()=>{this.blocked.delete(t.mapMarkerType);const r=this.markedDirty.get(t.mapMarkerType);this.markedDirty.delete(t.mapMarkerType),r&&this.redrawGeoScanContext(r)},M),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.strokeStyle="#fff",e.lineWidth=1,t.entities.forEach(r=>{const i=Math.round(r.r*t.surfaceRectSize),s=Math.round(r.x*t.surfaceRectSize/l-t.offset.x),a=Math.round(r.z*t.surfaceRectSize/l-t.offset.y);e.beginPath(),e.setLineDash([1,1]),e.ellipse(s,a,i,i,0,0,2*Math.PI),e.stroke()})}}redrawTerrain(t,e,r){this.surfaceContext&&(this.surfaceContext.fillStyle="#000",this.surfaceContext.fillRect(0,0,this.surfaceContext.canvas.width,this.surfaceContext.canvas.height),r.forEach(i=>i.forEach(s=>this.redrawSurface(t,e,s))))}redrawSurface(t,e,r){if(!this.surfaceContext)return;const i=Math.round(r.x*e-t.x),s=Math.round(r.y*e-t.y),a=e-L;this.surfaceContext.fillStyle=r.borderColor?r.borderColor:r.surfaceColor,this.surfaceContext.fillRect(i,s,a,a),r.borderColor&&(this.surfaceContext.fillStyle=r.surfaceColor,this.surfaceContext.fillRect(i,s,a,a))}redrawCamera(t,e,r){if(!this.cameraContext||(this.cameraContext.clearRect(0,0,this.cameraContext.canvas.width,this.cameraContext.canvas.height),!r))return;this.cameraContext.beginPath();const[i,s,a,n]=[r.topLeft,r.topRight,r.bottomRight,r.bottomLeft].map(R=>new f(R.x,R.z).multiplyScalar(e/l).sub(t));this.cameraContext.moveTo(i.x,i.y),this.cameraContext.lineTo(s.x,s.y),this.cameraContext.lineTo(a.x,a.y),this.cameraContext.lineTo(n.x,n.y),this.cameraContext.closePath(),this.cameraContext.strokeStyle="#ccc",this.cameraContext.lineWidth=.5,this.cameraContext.stroke(),this.cameraContext.beginPath();const u=s.clone().sub(i).multiplyScalar(.5).add(i),p=a.clone().sub(n).multiplyScalar(.5).add(n).clone().sub(u),w=p.clone().multiplyScalar(.15).add(u);this.cameraContext.moveTo(w.x,w.y);const x=n.clone().sub(i).multiplyScalar(.5).add(i),d=a.clone().sub(s).multiplyScalar(.5).add(s).clone().sub(x),k=d.clone().multiplyScalar(.65).add(x),m=d.clone().multiplyScalar(.55).add(x),T=p.clone().multiplyScalar(.425).add(m),b=d.clone().multiplyScalar(.35).add(x),C=d.clone().multiplyScalar(.45).add(x),E=p.clone().multiplyScalar(.425).add(C);this.cameraContext.lineTo(k.x,k.y),this.cameraContext.lineTo(m.x,m.y),this.cameraContext.lineTo(T.x,T.y),this.cameraContext.lineTo(E.x,E.y),this.cameraContext.lineTo(C.x,C.y),this.cameraContext.lineTo(b.x,b.y),this.cameraContext.closePath(),this.cameraContext.strokeStyle="#ccc",this.cameraContext.lineWidth=.5,this.cameraContext.stroke()}}const z=self;new A(new _(z))})();
//# sourceMappingURL=MapRendererWorker-EDdwntzS.js.map
